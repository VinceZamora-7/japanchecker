<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="UTF-8" />
<title>Coding Pre-processor</title>
<script src="https://cdn.ckeditor.com/ckeditor5/39.0.1/classic/ckeditor.js"></script>
<style>
  *, *::before, *::after {
    box-sizing: border-box;
  }

  body {
    margin: 0;
    background: #f8f9fa;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    font-size: 16px;
    color: #333;
    display: flex;
    justify-content: center;
    padding: 40px 15px;
  }

  .container {
    width: 100%;
    max-width: 720px;
    background: #fff;
    box-shadow: 0 4px 12px rgb(0 0 0 / 0.1);
    border-radius: 8px;
    padding: 30px 35px 40px;
  }

  h2 {
    margin-top: 0;
    margin-bottom: 15px;
    font-weight: 600;
    text-align: center;
    color: #222;
    letter-spacing: 0.04em;
  }

  .form-group {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    margin-bottom: 25px;
  }

  .form-group-column {
    display: flex;
    flex-direction: column;
    flex-grow: 1;
  }

  label {
    font-weight: 600;
    margin-bottom: 8px;
    color: #555;
    font-size: 0.95rem;
    user-select: none;
  }

  select,
  input[type="color"] {
    padding: 8px 12px;
    font-size: 1rem;
    border-radius: 6px;
    border: 1.5px solid #ccc;
    background-color: #fff;
    color: #333;
    cursor: pointer;
    transition: border-color 0.2s, box-shadow 0.2s;
    box-sizing: border-box;
    width: 100%;
  }

  select:hover,
  input[type="color"]:hover {
    border-color: #007bff;
    box-shadow: 0 0 5px rgba(0, 123, 255, 0.3);
  }

  select:focus,
  input[type="color"]:focus {
    border-color: #0056b3;
    box-shadow: 0 0 8px rgba(0, 86, 179, 0.5);
  }

  #editor {
    border: 1px solid #bbb;
    min-height: 150px;
    border-radius: 6px;
    font-size: 1rem;
    margin-bottom: 30px;
    box-sizing: border-box;
  }

  #output {
    font-family: 'Courier New', Courier, monospace;
    font-size: 11pt;
    white-space: pre-wrap;
    background-color: #f4f6f8;
    border: 1.5px solid #ddd;
    padding: 15px 18px;
    min-height: 200px;
    border-radius: 6px;
    resize: vertical;
    color: #222;
    line-height: 1.4;
    user-select: all;
    width: 100%;
  }

  button {
    cursor: pointer;
    padding: 10px 18px;
    font-size: 1rem;
    font-weight: 600;
    border: none;
    border-radius: 6px;
    background-color: #007bff;
    color: #fff;
    transition: background-color 0.3s ease, box-shadow 0.3s ease;
    display: block;
    margin-bottom: 15px;
    width: 100%;
    max-width: 160px;
    user-select: none;
  }

  button:hover {
    background-color: #0056b3;
    box-shadow: 0 0 8px rgba(0, 86, 179, 0.5);
  }

  button:active {
    background-color: #003f7f;
  }

  @media (max-width: 560px) {
    .container {
      padding: 25px 20px 30px;
    }

    #editor,
    #output {
      font-size: 14px;
    }

    button {
      max-width: 100%;
    }

    .form-group-column {
      flex: 1 1 100%;
    }
  }

  .note {
    font-size: 0.9rem;
    color: #666;
    text-align: center;
    margin-bottom: 20px;
  }
</style>
</head>

<body>
  <div class="container">
    <h2>Coding Pre-processor</h2>

    <div class="form-group">
      <div class="form-group-column">
        <label for="languageSelector">Select Language</label>
        <select id="languageSelector" onchange="renderOutput()">
          <option value="en">English</option>
          <option value="th">Thai</option>
          <option value="zh-cn">Chinese (Simplified)</option>
          <option value="zh-tw">Chinese (Traditional)</option>
          <option value="ko">Korean</option>
          <option value="ja">Japanese</option>
        </select>
      </div>

      <div class="form-group-column">
        <label for="tableCellColor">Cell Color</label>
        <input type="color" id="tableCellColor" />
      </div>
    </div>

    <textarea id="editor" placeholder="Paste or type content here..."></textarea>

    <h2>Generated HTML Code</h2>
    <button onclick="copyHTML()">Copy HTML Code</button>
    <textarea id="output" readonly></textarea>

    <h2>Preview</h2>
    <p class="note">Click a table cell below to change its background color</p>
    <div id="preview" style="border: 1.5px solid #ccc; padding: 15px; border-radius: 6px; min-height: 150px; background: #fff; overflow: auto;"></div>
  </div>

  <script>
    let editorInstance;
    let selectedCell = null;

    ClassicEditor
      .create(document.querySelector('#editor'), {
        toolbar: ['bold', 'italic', 'underline', '|', 'bulletedList', 'numberedList', 'link', 'insertTable', '|', 'undo', 'redo', '|', 'outdent', 'indent']
      })
      .then(editor => {
        editorInstance = editor;
        editor.model.document.on('change:data', () => {
          renderOutput();
        });
      })
      .catch(console.error);

    function formatHTML(html) {
      const tab = '  ';
      let result = '';
      let indent = '';

      html.split(/>\s*</).forEach(element => {
        element = element.trim();
        if (!element) return;

        if (element.startsWith('/')) indent = indent.slice(0, -tab.length);
        result += indent + '<' + element + '>\n';
        if (
          element.match(/^<?\w[^>]*[^\/]$/) &&
          !element.startsWith('br') &&
          !element.startsWith('hr') &&
          !element.startsWith('/')
        ) {
          indent += tab;
        }
      });

      return result.trim();
    }

    function renderOutput() {
      const content = editorInstance.getData();
      const parser = new DOMParser();
      const doc = parser.parseFromString(content, 'text/html');

      // Set all <a> elements with style color and underline + class target_black
      doc.querySelectorAll('a').forEach(link => {
        const styleAttr = link.getAttribute('style') || '';
        const cleanedStyle = styleAttr
          .split(';')
          .map(s => s.trim())
          .filter(s => s && !s.toLowerCase().startsWith('color:') && !s.toLowerCase().startsWith('text-decoration:'))
          .join('; ');
        link.setAttribute('style', `${cleanedStyle} color: #0067B8; text-decoration: underline`.trim());
        link.setAttribute('target', '_blank');
      });

      let updatedContent = doc.body.innerHTML;

      const fontMap = {
        "en": "'Segoe UI', Verdana, Geneva, Sans-serif",
        "th": "'Leelawadee', Arial, sans-serif",
        "zh-cn": "'Microsoft Yahei UI', Arial, sans-serif",
        "zh-tw": "'Microsoft JhengHei UI', Arial, sans-serif",
        "ko": "'Malgun Gothic', Arial, sans-serif",
        "ja": "'Yu Gothic UI', sans-serif"
      };

      const selectedLang = document.getElementById("languageSelector").value;
      const selectedFont = fontMap[selectedLang] || "'Segoe UI'";

      const style = `style="font-size: 13.5pt; font-family: ${selectedFont};"`;
      let styled = updatedContent
        .replace(/<p>/g, `<p ${style}>`)
        .replace(/<ul>/g, `<ul ${style}>`)
        .replace(/<li>/g, `<li ${style}>`)
        .replace(/<i>/g, `<em>`)
        .replace(/<\/i>/g, `</em>`)
        .replace(/<br>/g, `<br/>`);

      styled = styled
        .split('\n')
        .filter(line => line.trim() !== '')
        .join('\n')
        .replace(/\s{2,}/g, ' ')
        .replace(/&nbsp;\s+/g, '')
        .replace(/\s+&nbsp;/g, '')
        .replace(/<p[^>]*>(&nbsp;|\s)*<\/p>/gi, '')
        .trim();

      const formatted = formatHTML(styled);
      const trimmed = formatted.substring(1, formatted.length - 1);
      document.getElementById('output').textContent = trimmed;

      // Update preview panel
      const preview = document.getElementById('preview');
      preview.innerHTML = content;

      updateTableBordersInPreview();
      attachCellClickListeners();
    }

    function copyHTML() {
      const textarea = document.getElementById("output");
      const content = textarea.value.trim();

      if (!content) {
        alert("There is no generated HTML code to copy.");
        return;
      }

      textarea.select();
      textarea.setSelectionRange(0, 99999);
      document.execCommand("copy");
      alert("HTML code copied to clipboard!");
    }

    function updateTableBordersInPreview() {
      const preview = document.getElementById('preview');
      const tables = preview.querySelectorAll('table');

      tables.forEach(table => {
        table.style.borderCollapse = 'collapse';
        table.style.border = `1px solid black`; // default 1px black border
        table.querySelectorAll('td, th').forEach(cell => {
          cell.style.border = `1px solid black`;
        });
      });
    }

    function attachCellClickListeners() {
      const preview = document.getElementById('preview');
      const cells = preview.querySelectorAll('td, th');

      // Remove previous listeners by cloning elements
      cells.forEach(cell => {
        cell.replaceWith(cell.cloneNode(true));
      });

      preview.querySelectorAll('td, th').forEach(cell => {
        cell.addEventListener('click', () => selectCell(cell));
      });

      selectedCell = null;
      hideColorPicker();
    }

    function selectCell(cell) {
      if (selectedCell) {
        selectedCell.style.outline = '';
      }

      selectedCell = cell;
      selectedCell.style.outline = '3px solid #007bff';

      showColorPicker(selectedCell.style.backgroundColor || '#ffffff');
    }

    function showColorPicker(currentColor) {
      let container = document.getElementById('floatingColorPicker');

      if (!container) {
        container = document.createElement('div');
        container.id = 'floatingColorPicker';
        container.style.position = 'fixed';
        container.style.background = '#fff';
        container.style.border = '1px solid #ccc';
        container.style.padding = '8px';
        container.style.borderRadius = '6px';
        container.style.boxShadow = '0 2px 8px rgba(0,0,0,0.2)';
        container.style.zIndex = '9999';

        const colorInput = document.createElement('input');
        colorInput.type = 'color';
        colorInput.id = 'previewCellColorPicker';
        container.appendChild(colorInput);

        const applyBtn = document.createElement('button');
        applyBtn.textContent = 'Apply Color';
        applyBtn.style.marginLeft = '10px';
        applyBtn.style.cursor = 'pointer';
        applyBtn.style.padding = '6px 12px';
        applyBtn.style.borderRadius = '4px';
        applyBtn.style.border = 'none';
        applyBtn.style.backgroundColor = '#007bff';
        applyBtn.style.color = '#fff';
        applyBtn.addEventListener('click', applyColorToSelectedCell);
        container.appendChild(applyBtn);

        document.body.appendChild(container);
      }

      const colorInput = document.getElementById('previewCellColorPicker');
      colorInput.value = rgbToHex(currentColor);

      const rect = selectedCell.getBoundingClientRect();
      container.style.top = `${rect.bottom + window.scrollY + 5}px`;
      container.style.left = `${rect.left + window.scrollX}px`;
      container.style.display = 'flex';
    }

    function hideColorPicker() {
      const container = document.getElementById('floatingColorPicker');
      if (container) {
        container.style.display = 'none';
      }
    }

    function rgbToHex(rgb) {
      if (!rgb) return '#ffffff';
      if (rgb.startsWith('#')) return rgb;

      const rgbMatch = rgb.match(/^rgba?\((\d+),\s*(\d+),\s*(\d+)/);
      if (!rgbMatch) return '#ffffff';

      const r = parseInt(rgbMatch[1]).toString(16).padStart(2, '0');
      const g = parseInt(rgbMatch[2]).toString(16).padStart(2, '0');
      const b = parseInt(rgbMatch[3]).toString(16).padStart(2, '0');

      return `#${r}${g}${b}`;
    }

    function applyColorToSelectedCell() {
      if (!selectedCell) {
        alert('Please select a cell first.');
        return;
      }

      const colorInput = document.getElementById('previewCellColorPicker');
      const chosenColor = colorInput.value;

      selectedCell.style.backgroundColor = chosenColor;

      updateEditorContentFromPreview();
      renderOutput();
    }

    function updateEditorContentFromPreview() {
      const preview = document.getElementById('preview');
      const clone = preview.cloneNode(true);

      // Remove outline style if any
      const outlinedCell = clone.querySelector('[style*="outline"]');
      if (outlinedCell) {
        outlinedCell.style.outline = '';
      }

      const newHTML = clone.innerHTML;
      editorInstance.setData(newHTML);
    }
  </script>
</body>

</html>
